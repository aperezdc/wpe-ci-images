#! /bin/zsh
emulate -L zsh
setopt multios err_return

# Make sure no aliases are defined. At all.
unalias -a -s

# Automatically pick helpers from the functions/ subdir.
fpath="${0:A:h}/functions" autoload -RUz "${0:A:h}/functions"/*(.:t)

# Handle all the ': require ...' lines.
declare -a required=()
declare -a line
while read -A line ; do
	[[ ${#line} -gt 2 && ${(f)line[1,2]} = :\ require ]] || continue
	required+=( "${(@)line[3,-1]}" )
done < "${0:A:h}/functions"/*(.)

require "${(u)required[@]}"
require pigz tar
	
unset line
unset required

zmodload zsh/zutil
zmodload zsh/stat

# Parse command line options.
declare -a PKGLIST_DEFINES
declare -a pkglist_files
declare -A OPTS=()

zparseopts -A OPTS -D -M -E \
	h -help=h \
	o: -output:=o \
	D+:-=PKGLIST_DEFINES -define+:-=D \
	p+:-=pkglist_files -pkglist+:-=p

pkglist_files=( "${pkglist_files[@]#-p}" )

if [[ ${OPTS[-h]+set} = set ]] ; then
	show-help "${0}" 0
fi

declare -a packages=( "$@" )
if [[ ${#pkglist_files} -gt 0 ]] ; then
	packages=( $(pkglist "${pkglist_files[@]}") "$@" )
fi

[[ -n ${OPTS[-o]} ]] || die 'No image output path specified'
[[ ${#packages} -gt 0 ]] || die 'No packages specified'

declare -r O=${OPTS[-o]}
declare -r rootfs_path="${O}/rootfs"
declare -r blobs_path="${O}/blobs"

if [[ ! -r ${rootfs_path}.tar.gz ]] ; then
	mkdir -p "${rootfs_path}"
	pacstrap -C <(gen-pacman-conf) -c -M "${rootfs_path}" "${packages[@]}"
	tar -C "${rootfs_path}" -cf "${rootfs_path}.tar" .
	sha256 "${rootfs_path}.tar" > "${rootfs_path}.tar.sum"
	pigz -9 "${rootfs_path}.tar"
	sha256 "${rootfs_path}.tar.gz" > "${rootfs_path}.tar.gz.sum"
fi

cat > "${O}/config.json" <<EOF
{
	"architecture": "amd64",
	"os": "linux",
	"rootfs": {
		"type": "layers",
		"diff_ids": [
			"sha256:$(< "${rootfs_path}.tar.sum")"
		]
	}
}
EOF
sha256 "${O}/config.json" > "${O}/config.json.sum"

mkdir -p "${blobs_path}"
echo 'Directory Transport Version: 1.1' > "${blobs_path}/version"
ln -f "${rootfs_path}.tar.gz" "${blobs_path}/$(< "${rootfs_path}.tar.gz.sum")"
ln -f "${O}/config.json" "${blobs_path}/$(< "${O}/config.json.sum")"
cat > "${blobs_path}/manifest.json" <<EOF
{
	"schemaVersion": 2,
	"mediaType": "application/vnd.docker.distribution.manifest.v2+json",
	"config": {
		"mediaType": "application/vnd.docker.container.image.v1+json",
		"digest": "sha256:$(< "${O}/config.json.sum")",
		"size": $(zstat +size "${O}/config.json")
	},
	"layers": [
		{
			"mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
			"digest": "sha256:$(< "${rootfs_path}.tar.gz.sum")",
			"size": $(zstat +size "${rootfs_path}.tar.gz")
		}
	]
}
EOF
