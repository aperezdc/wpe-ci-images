version: 2
jobs:
  build-imagebuild:
    docker:
      - image: aperezdc/ci-imagebuild:latest
    steps:
      - checkout
      - restore_cache:
          keys:
            - pkgcache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "base.pkginc" }}-{{ checksum "imagebuild.pkglist" }}
            - pkgcache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "base.pkginc" }}-
            - pkgcache-v1-{{ arch }}-{{ .Branch }}-
            - pkgcache-v1-{{ arch }}-
      - run:
          name: Build
          command: |
            rm -rf _imagebuild
            ./build -N -P _pkgcache -o _imagebuild -p imagebuild.pkglist -C imagebuild.json
      - save_cache:
          key: pkgcache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "base.pkginc" }}-{{ checksum "imagebuild.pkglist" }}
          paths:
            - _pkgcache
      - run:
          name: Source Archive
          command: |
            git archive --prefix=src/ -o _imagebuild/src.tar @
      - persist_to_workspace:
          root: _imagebuild
          paths:
            - blobs
            - src.tar

  check-imagebuild:
    docker:
      - image: aperezdc/ci-imagebuild:latest
    steps:
      - attach_workspace:
          at: output
      - setup_remote_docker
      - run:
          name: Prepare
          command: |
            VER=18.06.1
            curl -sL "https://download.docker.com/linux/static/stable/x86_64/docker-${VER}-ce.tgz" \
              | tar --strip-components=1 -C /usr/bin -xz docker/docker
            skopeo copy dir:output/blobs/ docker-archive:ci-imagebuild.tar:ci-imagebuild
            docker load --input ci-imagebuild.tar
            docker exec ci-imagebuild /usr/bin/ls -lR /home
            docker cp - ci-imagebuild:home/build < output/src.tar

  upload-imagebuild:
    docker:
      - image: aperezdc/ci-imagebuild:latest
    steps:
      - attach_workspace:
          at: output
      - run:
          name: Upload
          command: |
            skopeo copy --dest-creds "${DOCKERHUB_USERNAME}:${DOCKERHUB_PASSWORD}" \
                dir:output/blobs/ docker://docker.io/aperezdc/ci-imagebuild

  build-libwpe:
    docker:
      - image: aperezdc/ci-imagebuild:latest
    steps:
      - checkout
      - restore_cache:
          keys:
            - pkgcache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "base.pkginc" }}-{{ checksum "libwpe.pkglist" }}
            - pkgcache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "base.pkginc" }}-
            - pkgcache-v1-{{ arch }}-{{ .Branch }}-
            - pkgcache-v1-{{ arch }}-
      - run:
          name: Build
          command: |
            rm -rf _libwpe
            ./build -N -P _pkgcache -o _libwpe -p libwpe.pkglist
      - save_cache:
          key: pkgcache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "base.pkginc" }}-{{ checksum "libwpe.pkglist" }}
          paths:
            - _pkgcache
      - persist_to_workspace:
          root: _libwpe
          paths:
            - blobs

  upload-libwpe:
    docker:
      - image: aperezdc/ci-libwpe:latest
    steps:
      - attach_workspace:
          at: output
      - run:
          name: Upload
          command: |
            skopeo copy --dest-creds "${DOCKERHUB_USERNAME}:${DOCKERHUB_PASSWORD}" \
                dir:output/blobs/ docker://docker.io/aperezdc/ci-libwpe

workflows:
  version: 2
  build:
    jobs:
      - build-imagebuild

      - check-imagebuild:
          requires:
            - build-imagebuild

      - upload-imagebuild:
          context: wpe-ci
          requires:
            - check-imagebuild
          filters:
            branches:
              only: /^master$/

      - build-libwpe:
          requires:
            - upload-imagebuild
          filters:
            branches:
              only: /^master$/

      - upload-libwpe:
          context: wpe-ci
          requires:
            - build-libwpe
          filters:
            branches:
              only: /^master$/
